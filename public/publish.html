<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>指南发布广告</title>
    <link type="text/css" rel="stylesheet" href="./css/navigation_bar.css">
    <link rel="stylesheet" href="./css/publishAd.css"/>
    <script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/jquery.form/3.51/jquery.form.min.js"></script>
    <link href="http://cdn.bootcss.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="js/login_common.js"></script>
    <script src="./js/login_common.js"></script>
    <script src="./js/jquery.uploadView.js"></script>
</head>
<body>
<div class="ue-content-media">
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="ue-bar">
            <div class="ue-bar-warp">
                <div class="us-bar-logo">
                    <a href="#">
                        <img src="./img/logo.png" width="auto" height="80%" alt="指南" title="指南">
                    </a>
                </div>
                <div class="ue-bar-nav">
                    <ul>
                        <li><a href="index.html">
                            <em>首页</em>
                        </a></li>
                        <li class="active"><a href="publish.html">
                            <em>发布广告</em>
                        </a></li>
                        <li><a target="_blank" href="http://115.159.0.155:8080/manage/login">
                            <em>问卷调查</em>
                        </a></li>
                        <li><a href="about.html">
                            <em>关于</em>
                        </a></li>
                    </ul>
                </div>
                <div class="ue-bar-login">
                    <a href="login.html">
                        <img src="./img/web_log-in.png" width="auto" alt="登陆" title="登陆">
                    </a>
                </div>

            </div>
        </div>
    </nav>
    <!--<form method='post' action='http://123.206.84.242:2888/postNew' enctype="multipart/form-data"-->
    <!--onsubmit="return checkAd()">-->
    <div id="publish-AD">
        <div class="ad-informattion">
            <div class="adtitle">
                <img src="img/adico.png">
                <span style="color: #33ccff">广告基本信息</span>
                <a href="#" onclick="alert('暂未开放')" style="color: #33ccff">广告任务流程说明</a>
            </div>
        </div>
        <div class="ad-informattion-list">
            <div class="ad-informattion-content">
                <div class="informattion-list">
                    <label class="informattion-list-label">广告名称</label>
                    <input type="text" name="ad_name" class="list-input wordstyle"/>
                </div>
                <div class="informattion-list">
                    <label class="informattion-list-label">广告图片</label>
                </div>
                <div class="informattion-list1">
                    <!--<div class="picBox">-->

                    <div class="showpic"></div>
                    <!--<input type="file" name="pic" style="display:none;">-->
                    <!--&lt;!&ndash;<form enctype="multipart/form-data" id="form1" method="post" action="">&ndash;&gt;-->
                    <!--<form id="uploadForm">-->
                    <!--<input type="file" name="pic" id="upload_Pic">-->
                    <!--<input id="subbtn" type="submit">-->
                    <!--&lt;!&ndash;<img src="img/add.png"  class="upload" style="display:none;" id="upload">&ndash;&gt;-->
                    <!--</form>-->
                    <!--</div>-->
                    <form id="uploadForm">
                        <input type="file" name="FileContent" id="upload_Pic">
                        <input id="submitPic" style="display: none" type="submit">
                    </form>
                </div>
            </div>
        </div>
        <div class="ad-informattion-list">
            <div class="ad-informattion-content">
                <div class="informattion-list">
                    <label class="informattion-list-label1">广告关键词</label>
                    <textarea class=" wordstyle ad-need " name="ad_explain"
                              placeholder="请输入广告关键词，请控制在4～10个字内"></textarea>
                </div>
                <div class="informattion-list">
                    <label class="informattion-list-label1">广告投放时间</label>
                    <input class="ad-time" type="date" name="ad_put_begintime" id="ad_put_begintime">
                    <span class="to">至今</span>
                    <input type="date" name="ad_put_endtime" class="ad-time" id="ad_put_endtime">
                </div>
                <div class="informattion-list">
                    <label class="informattion-list-label1">广告预算金币</label>
                    <input class="budget" type="text" name="budget">
                </div>
                <div class="informattion-list">
                    <label class="informattion-list-label1">单笔奖励金币</label>
                    <input class="sig_money" type="text" name="sig_money" id="sig_money">
                </div>
                <div class="informattion-list" id="fenlei">
                    <label class="informattion-list-label1">投放分类</label>
                    <div class="checkbox-list"><input type="checkbox" name="game" value="1"><span>教育</span></div>
                    <div class="checkbox-list"><input type="checkbox" name="entertainment" value="1"><span>旅游</span>
                    </div>
                    <div class="checkbox-list"><input type="checkbox" name="sports" value="1"><span>房产</span></div>
                    <div class="checkbox-list"><input type="checkbox" name="cars" value="1"><span>建材</span></div>
                    <div class="checkbox-list"><input type="checkbox" name="finance" value="1"><span>医药</span></div>
                    <div class="checkbox-list1"><input type="checkbox" name="education" value="1"><span>餐饮</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="end">
            <button class="publish" onclick="submitInfo()" style="font-size: 20px;">发布</button>
        </div>
    </div>
    <div class="ad-informattion-list wenan-page" style="margin-top:-40px;">
        <div class="ad-informattion-content">
            <div class="informattion-list">
                <label class="informattion-list-label11">文案名称</label>
                <input type="text" name="wenan_name" class="list-input wordstyle" placeholder="文案名称"/>
            </div>
            <div class="informattion-list" style="margin-top:20px;">
                <label class="informattion-list-label11">文案正文</label>
            </div>
            <div class="end">
                <input class=" publish-wenan publish-wenan-cancel" value="取消"/>
                <input class=" publish-wenan publish-wenan-ok" value="提交"/>
            </div>
        </div>
    </div>
    <script>
        var imgs = [];
        var ad_name, ad_explain, ad_put_begintime, ad_put_endtime, budget, sig_money;
        var tag = new Array();
        function checkAd() {
            $(".ad-informattion-list").find(".warning").remove();
            ad_name = $("input[name='ad_name']").val();
            if (ad_name == "" || ad_name == null) {
                var span = $("<span class='warning'>请您输入广告名称！</span>");
                $("input[name='ad_name']").parent(".informattion-list").append(span);
            }
//            if (pic == "" || pic == null) {
//                var span = $("<span class='warning'>请您上传广告图片！</span>");
//                $("#upload_Pic").parent(".informattion-list").append(span);
//
//            }
            ad_explain = $("textarea[name='ad_explain']").val();
            if (ad_explain == "" || ad_explain == null) {
                var span = $("<span class='warning'>请您输入广告任务说明！</span>");
                $("textarea[name='ad_explain']").parent(".informattion-list").append(span);

            }

            ad_put_begintime = $("input[name='ad_put_begintime']").val();
            if (ad_put_begintime == "" || ad_put_begintime == null) {
                var span = $("<span class='warning'>请您输入广告投放开始时间！</span>");
                $("input[name='ad_put_begintime']").parent(".informattion-list").append(span);
            }
            ad_put_endtime = $("input[name='ad_put_endtime']").val();
            if (ad_put_endtime == "" || ad_put_endtime == null) {
                var span = $("<span class='warning'>请您输入广告投放结束时间！</span>");
                $("input[name='ad_put_endtime']").parent(".informattion-list").append(span);
            }

            budget = $("input[name='budget']").val();
            if (budget == "" || budget == null) {
                var span = $("<span class='warning'>请您输入广告预算金额！</span>");
                $("input[name='budget']").parent(".informattion-list").append(span);
            }
            else if (budget <= 0) {
                var span = $("<span class='warning'>广告预算金额应大于0元！</span>");
                $("input[name='budget']").parent(".informattion-list").append(span);
            }
            jiaoyu = $("input[name='game']").is(':checked');
            lvyou = $("input[name='entertainment']").is(':checked');
            //教育 旅游 房产 建材 医药 餐饮
            fangchan = $("input[name='sports']").is(':checked');
            jiancai = $("input[name='cars']").is(':checked');

            yiyao = $("input[name='finance']").is(':checked');

            canyin = $("input[name='education']").is(':checked');
            fenlei = (jiaoyu || lvyou || fangchan || jiancai || yiyao || canyin);
            if (fenlei == false) {
                var span = $("<span class='warning'>请您选择广告分类！</span>");
                $("#fenlei").append(span);
            }

            if (ad_name && ad_explain && ad_put_begintime && ad_put_endtime && (budget > 0) && fenlei) {
                if (jiaoyu) tag[0] = 1; else tag[0] = 0;
                if (lvyou) tag[1] = 1; else tag[1] = 0;
                if (fangchan) tag[2] = 1; else tag[2] = 0;
                if (jiancai) tag[3] = 1; else tag[3] = 0;
                if (yiyao) tag[4] = 1; else tag[4] = 0;
                if (canyin) tag[5] = 1; else tag[5] = 0;
                for (var i = 0; i < tag.length; i++) {
                    res += tag[i];
                }
                console.log(res);
                console.log("cheng123");
                return true;
            }
            else {
                console.log("shibai121212");
                return false;
            }
        }
        var res;
        function submitInfo() {
            var res = checkAd();
            console.log(imgs);
            if (res) {
                $.ajax({
                    type: 'POST',
                    url: '/postNew',
                    data: {
                        "name": ad_name,   //广告名称
                        "imgurls": imgs,  //图片地址
                        "key": ad_explain,  //广告关键字
                        "ad_put_begintime": ad_put_begintime, //广告投放开始时间
                        "ad_put_endtime": ad_put_endtime, //广告投放结束时间
                        "budget": budget,  //广告预算金币
                        "sig_money": sig_money,  //单笔奖励金币
                        "tags": res, //类别
                        "addesc": "快来买呀！便宜处理了"   //广告描述
                    },
                    dataType: "json",
                    success: function (result) {
                        if (result.status == "success") {
                            alert('成功');
                            window.location.reload();
                        } else {
                            alert(result.error);
//                            window.location.reload();
                        }
                    }
                });
            }

        }
        var moneyIsEnough = true;
        var isShow = false;
        $(document).ready(function () {
            $(".menu_top").css("min-width", "1920px");
            $(".menu_top").css("width", "100%");
            $(".menu_bottom").css("min-width", "1920px");
            $(".menu_bottom").css("width", "100%");
            $(".menu_bottom_next").css("width", "23%");
            $(".newrank_foot").css("min-width", "1920px");
            $(".newrank_foot").css("width", "100%");
            $(".edit-wenan").on("click", function () {
                $("#publish-AD").css("display", "none");
                $(".wenan-page").css("display", "block");
            });
            $(".publish-wenan-ok").on("click", function () {
                if ($("#WNedit").children("span").hasClass("informattion-list-label22")) {
                    $("#WNedit").find(".informattion-list-label22").remove();
                }
                $("#publish-AD").css("display", "block");
                $(".wenan-page").css("display", "none");
                var wenan_name = $("input[name='wenan_name']").val();
                var span = $("<span class='informattion-list-label22'  > " + wenan_name + "</span>");
                $(".edit-wenan").before(span);

            });
            $(".publish-wenan-cancel").on("click", function () {
                $("#publish-AD").css("display", "block");
                $(".wenan-page").css("display", "none");
                $("input[name='wenan_name']").val("");

            });
            var pic_width = $(".showpic").width();
//            $(".upload").on("click", function () {
//                pic_width = $(".showpic").width();
//                $("input[name='pic']").click();
//
//            });

//            $("#upload_Pic").on("click", function () {
//                pic_width = $(".showpic").width();
//                $("input[name='pic']").click();
//                //  alert(pic_width);
//            });
//            $("input[name='pic']").uploadView({
//                uploadBox: '.picBox',//设置上传框容器
//                showBox: '.showpic',//设置显示预览图片的容器
//                width: pic_width,
//                height: 300, //预览图片的高度，单位px
//                allowType: ["gif", "jpeg", "jpg", "bmp", "png"], //允许上传图片的类型
//                maxSize: 2, //允许上传图片的最大尺寸，单位M
//                success: function (e) {
////                    $(".upload").css("display", "none");
//                    //  alert(pic_width);
//                    $(".informattion-list1 .picBox img").css("width", pic_width);
//                }
//            });

        })


        $("input[name='ad_name']").on("blur", function () {
            if ($("input[name='ad_name']").parent(".informattion-list").has(".warning")) {
                $("input[name='ad_name']").parent(".informattion-list").find(".warning").remove();
            }
            var ad_name = $("input[name='ad_name']").val();
            if (ad_name == "" || ad_name == null) {
                var span = $("<span class='warning'>请您输入广告名称！</span>");
                $("input[name='ad_name']").parent(".informattion-list").append(span);
            }
            else if ($("input[name='ad_name']").parent(".informattion-list").has(".warning")) {
                {
                    $("input[name='ad_name']").parent(".informattion-list").find(".warning").remove();
                }

            }
        })

        $("input[name='pic']").on("change", function () {
            if ($("input[name='pic']").parent(".informattion-list").has(".warning")) {
                $("#upload_Pic").parent(".informattion-list").find(".warning").remove();
            }
            var pic = $("input[name='pic']").val();
            if (pic == "" || pic == null) {
                var span = $("<span class='warning'>请您上传广告图片！</span>");
                $("#upload_Pic").parent(".informattion-list").append(span);
            }
            else if ($("#upload_Pic").parent(".informattion-list").has(".warning")) {
                {
                    $("#upload_Pic").parent(".informattion-list").find(".warning").remove();
                }

            }
        })
        $("textarea[name='ad_explain']").on("blur change", function () {
            if ($("textarea[name='ad_explain']").parent(".informattion-list").has(".warning")) {
                $("textarea[name='ad_explain']").parent(".informattion-list").find(".warning").remove();
            }
            var ad_explain = $("textarea[name='ad_explain']").val();
            if (ad_explain == "" || ad_explain == null) {
                var span = $("<span class='warning'>请您输入广告任务说明</span>");
                $("textarea[name='ad_explain']").parent(".informattion-list").append(span);
            }
            else if ($("textarea[name='ad_explain']").parent(".informattion-list").has(".warning")) {
                {
                    $("textarea[name='ad_explain']").parent(".informattion-list").find(".warning").remove();
                }

            }
        })


        $("input[name='ad_put_begintime']").on("blur change", function () {
            if ($("input[name='ad_put_begintime']").parent(".informattion-list").has(".warning")) {
                $("input[name='ad_put_begintime']").parent(".informattion-list").find(".warning").remove();
            }
            var ad_put_begintime = $("input[name='ad_put_begintime']").val();
            if (ad_put_begintime == "" || ad_put_begintime == null) {
                var span = $("<span class='warning'>请您输入广告投放开始时间！</span>");
                $("input[name='ad_put_begintime']").parent(".informattion-list").append(span);
            }
            else if ($("input[name='ad_put_begintime']").parent(".informattion-list").has(".warning")) {
                {
                    $("input[name='ad_put_begintime']").parent(".informattion-list").find(".warning").remove();
                    var endDate = $("input[name='ad_put_begintime']").val().split("-");
                    var year = endDate[0];
                    var mont = endDate[1];
                    var month = parseInt(mont) - 1;
                    var day = endDate[2];
                    var dateEnd = new Date(year, month, day);
                    var today = new Date().getTime();
                    var timeEnd = dateEnd.getTime();
                    if (timeEnd < today) {
                        var span = $("<span class='warning'>广告投放开始时间须大于当前时间！</span>");
                        $("input[name='ad_put_begintime']").parent(".informattion-list").append(span);
                    }
                }
            }
        })

        $("input[name='ad_put_endtime']").on("blur change", function () {
            if ($("input[name='ad_put_endtime']").parent(".informattion-list").has(".warning")) {
                $("input[name='ad_put_endtime']").parent(".informattion-list").find(".warning").remove();
            }
            var ad_put_endtime = $("input[name='ad_put_endtime']").val();
            if (ad_put_endtime == "" || ad_put_endtime == null) {
                var span = $("<span class='warning'>请您输入广告投放结束时间！</span>");
                $("input[name='ad_put_endtime']").parent(".informattion-list").append(span);
            }
            else if ($("input[name='ad_put_endtime']").parent(".informattion-list").has(".warning")) {
                {
                    $("input[name='ad_put_endtime']").parent(".informattion-list").find(".warning").remove();

                    var endDate = $("input[name='ad_put_begintime']").val().split("-");
                    var year = endDate[0];
                    var mont = endDate[1];
                    var month = parseInt(mont) - 1;
                    var day = endDate[2];
                    var dateEnd = new Date(year, month, day);
                    var timeEnd = dateEnd.getTime();

                    var endDate1 = $("input[name='ad_put_endtime']").val().split("-");
                    var year1 = endDate1[0];
                    var mont1 = endDate1[1];
                    var month1 = parseInt(mont1) - 1;
                    var day1 = endDate1[2];
                    var dateEnd1 = new Date(year1, month1, day1);
                    var timeEnd1 = dateEnd1.getTime();

                    if (timeEnd1 < timeEnd) {
                        var span = $("<span class='warning'>广告投放结束时间须大于开始时间！</span>");
                        $("input[name='ad_put_begintime']").parent(".informattion-list").append(span);
                    }
                }

            }
        })


        $("input[name='budget']").on("blur change", function () {
            moneyIsEnough = false;
            if ($("input[name='budget']").parent(".informattion-list").has(".warning")) {
                $("input[name='budget']").parent(".informattion-list").find(".warning").remove();
            }
            budget = $("input[name='budget']").val();
            if (budget == "" || budget == null) {
                var span = $("<span class='warning'>请您输入预算金额！</span>");
                $("input[name='budget']").parent(".informattion-list").append(span);
            } else if (budget <= 0) {
                var span = $("<span class='warning'>广告预算金额应大于0元！</span>");
                $("input[name='budget']").parent(".informattion-list").append(span);
            } else {
                //其它
            }
        })
        $(".sig_money").on("blur change", function () {
            if ($(".sig_money").parent(".informattion-list").has(".warning")) {
                $(".sig_money").parent(".informattion-list").find(".warning").remove();
            }
            sig_money = $(".sig_money").val();
            if (sig_money == "" || sig_money == null) {
                var span = $("<span class='warning'>请您输入单笔金额！</span>");
                $(".sig_money").parent(".informattion-list").append(span);
            } else if (sig_money < 0) {
                var span = $("<span class='warning'>请您输入单笔金额！</span>");
                $(".sig_money").parent(".informattion-list").append(span);
            } else {
                //其他处理
            }
        })
        $("input[name='game'] ,input[name='entertainment'],input[name='sports'],input[name='cars'],input[name='finance'],input[name='education']").on("change", function () {
            if ($("#fenlei").has(".warning")) {
                $("#fenlei").find(".warning").remove();
            }
            var game = $("input[name='game']").is(':checked');
            var entertainment = $("input[name='entertainment']").is(':checked');

            var sports = $("input[name='sports']").is(':checked');

            var cars = $("input[name='cars']").is(':checked');

            var finance = $("input[name='finance']").is(':checked');

            var education = $("input[name='education']").is(':checked');
            var fenlei = (game || entertainment || sports || cars || finance || education);
            if (fenlei == false) {
                var span = $("<span class='warning'>请您选择广告分类！</span>");
                $("#fenlei").append(span);
            }
        })

        function deleteImg(a) {
            a.remove();
        }
        $("#upload_Pic").change(function (e) {
            for (var i = 0; i < e.target.files.length; i++) {
                var file = e.target.files.item(i);
                var freader = new FileReader();
                freader.readAsDataURL(file);
                freader.onload = function (e) {
                    var src = e.target.result;
                    $(".showpic").append("<div><img class='show_img' ondblclick='deleteImg (this)' src=" + src + "></div>");
//                    request1();
                }
            }
            $("#submitPic").click();
            initUploadForm();
        });
        $('input[name=pic]').change(function () {
            initUploadForm();
        });
        var url;
        var sign;
        //        function request1() {
        //            $.ajax({
        //                type: "GET",
        //                url: "http://123.206.84.242:2888/tx/img?type=upload",
        ////                data: {},
        //                dataType: 'json',
        //                success: function (result) {
        //                    url = result.url;
        //                    sign = result.sign;
        //                    request2();
        //                }
        //            });
        //        }
        //        function request2() {
        ////            $.ajax({
        ////                type: "GET",
        ////                url: url + "?sign=" + sign,
        //////                data: {},
        ////                dataType: 'json',
        ////                success: function (result) {
        ////                    url = result.url;
        ////                    sign = result.sign;
        ////                }
        ////            });
        //            var url_pic = url + "?sign=" + encodeURIComponent(sign);
        ////            $("#form1").ajaxSubmit({
        ////                url: url_pic,
        ////                type: "POST",
        ////                //date:"upfile=upfile",
        ////                success: function (response) {
        ////                    alert(response);
        ////                },
        ////                error: function (msg) {
        ////                    alert("出错了");
        ////                }
        ////            });
        //            var options = {
        //                type: 'post',
        //                url: url_pic,
        //                dataType: 'json',
        //                contentType: "multipart/form-data",
        //                success: function (ret) {
        //                    alert("chengg!")
        //                },
        //                error: function (ret) {
        //                    alert(ret.responseText);
        //                }
        //            };
        //
        //            // pass options to ajaxForm
        //            $('#uploadForm').ajaxForm(options);
        //        }
        $(document).ready(function () {
            initUploadForm();
        });
        //        $('#upload_Pic').change(function () {
        //            initUploadForm();
        //        });
        function initUploadForm() {
            // 请将以下获取签名的链接换成您部署好的服务端http url
            // 建议通过业务登陆态检查来增强安全性，避免签名被非法获取
            $.getJSON('../tx/img?type=upload', function (data) {
                var sign = data.sign,
                        url = data.url + '?sign=' + encodeURIComponent(sign);

                var options = {
                    type: 'post',
                    url: url,
                    dataType: 'json',
                    contentType: "multipart/form-data",
                    success: function (ret) {
//                        $('#downloadUrl').html(ret.data.download_url);
//                        $('#fileid').text(ret.data.fileid);
//                        $('#url').text(ret.data.url);
//                        $('#downloadRet').show();
                        imgs.push(ret.data.download_url);
                        console.log(ret)
                    },
                    error: function (ret) {
                        alert(ret.responseText);
                    }
                };

                // pass options to ajaxForm
                $('#uploadForm').ajaxForm(options);
            });
        }
    </script>


</div>

</body>
</html>
